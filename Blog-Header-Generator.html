<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Blog Header Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --radius: 16px;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            padding: 40px 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr; /* Â∑¶‰æßÊéßÂà∂ÔºåÂè≥‰æßÈ¢ÑËßà */
            gap: 40px;
            align-items: start;
        }

        /* --- Left Sidebar (Controls) --- */
        .sidebar {
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            border: var(--glass-border);
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            position: sticky;
            top: 40px;
        }

        /* Scrollbar styling */
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .logo-area { margin-bottom: 30px; text-align: center; }
        .logo-area h1 { font-size: 1.5rem; font-weight: 800; background: linear-gradient(to right, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-area p { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; }

        /* Template Switcher */
        .template-switcher {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .t-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .t-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Form Controls */
        .control-group { margin-bottom: 24px; }
        .control-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: #f8fafc;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* File Upload */
        .file-upload { position: relative; width: 100%; }
        .file-upload input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s;
        }
        .upload-box.dragover { border-color: var(--primary); background: #e0e7ff; }
        .upload-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .upload-text { font-size: 0.8rem; color: var(--text-sub); }

        /* Color & Range Inputs */
        .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 42px;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #e2e8f0; border-radius: 8px; }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* --- Right Area (Preview) --- */
        .preview-area {
            position: sticky;
            top: 40px;
        }

        .canvas-wrapper {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
            line-height: 0; /* remove bottom gap */
        }

        canvas {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #f1f5f9;
        }

        .hint {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .canvas-wrapper:hover .hint { opacity: 1; }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

        .hidden { display: none !important; }

        @media (max-width: 1000px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { max-height: none; position: static; }
            .preview-area { position: static; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="logo-area">
            <h1>Header Gen</h1>
            <p>Professional Blog Asset Creator</p>
        </div>

        <div class="template-switcher">
            <button class="t-btn active" data-template="blog" onclick="switchTemplate('blog')">üìù Blog Cover</button>
            <button class="t-btn" data-template="vs" onclick="switchTemplate('vs')">‚öîÔ∏è VS Battle</button>
        </div>

        <div id="blog-controls">
            <div class="control-group">
                <label>Background Image</label>
                <div class="file-upload">
                    <input type="file" id="bg-upload" accept="image/*">
                    <div class="upload-box">
                        <span class="upload-icon">üì∏</span>
                        <span class="upload-text">Drop image or click to upload</span>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>Main Title</label>
                <textarea id="blog-title" rows="2">How to Build Amazing Websites</textarea>
            </div>

            <div class="control-group">
                <label>Subtitle / Category</label>
                <input type="text" id="blog-subtitle" value="VIOX Knowledge Base">
            </div>

            <div class="control-group row-inputs">
                <div>
                    <label>Overlay Opacity</label>
                    <input type="range" id="overlay-opacity" min="0" max="90" value="50">
                </div>
                <div>
                    <label>Font Size</label>
                    <input type="range" id="font-scale" min="80" max="150" value="100">
                </div>
            </div>

            <div class="control-group row-inputs">
                <div>
                    <label>Text Color</label>
                    <input type="color" id="color-primary" value="#ffffff">
                </div>
                <div>
                    <label>Accent Color</label>
                    <input type="color" id="color-accent" value="#fbbf24">
                </div>
            </div>
        </div>

        <div id="vs-controls" class="hidden">
            <div class="control-group">
                <label>Comparison Title</label>
                <input type="text" id="vs-title" value="DIFFERENCE BETWEEN DC SPD AND AC SPD">
            </div>

            <div class="control-group row-inputs">
                <div>
                    <label>Left Product Image</label>
                    <div class="file-upload">
                        <input type="file" id="left-img" accept="image/*">
                        <div class="upload-box">
                            <span class="upload-text">Upload Left</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label>Right Product Image</label>
                    <div class="file-upload">
                        <input type="file" id="right-img" accept="image/*">
                        <div class="upload-box">
                            <span class="upload-text">Upload Right</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-group row-inputs">
                <div>
                    <label>Left Name</label>
                    <input type="text" id="left-name" value="DC SPD">
                </div>
                <div>
                    <label>Right Name</label>
                    <input type="text" id="right-name" value="AC SPD">
                </div>
            </div>

            <div class="control-group">
                <label>Left Description</label>
                <textarea id="left-desc" rows="2">Works on thermal and electrical properties of conducting materials</textarea>
            </div>
            
            <div class="control-group">
                <label>Right Description</label>
                <textarea id="right-desc" rows="2">Works on switching principle and electromagnetism</textarea>
            </div>

            <div class="control-group row-inputs">
                <div>
                    <label>Header BG</label>
                    <input type="color" id="vs-header-bg" value="#8e44ad">
                </div>
                <div>
                    <label>Left Button</label>
                    <input type="color" id="vs-left-col" value="#ff6b35">
                </div>
            </div>
            <div class="control-group row-inputs">
                <div>
                    <label>Header Text</label>
                    <input type="color" id="vs-header-text" value="#ffffff">
                </div>
                <div>
                    <label>Right Button</label>
                    <input type="color" id="vs-right-col" value="#e84393">
                </div>
            </div>
        </div>

        <div class="control-group" style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
            <label>Website URL</label>
            <input type="text" id="website-url" value="www.viox.com">
        </div>
        
        <div class="control-group">
            <label>Font Style</label>
            <select id="font-family">
                <option value="Inter">Inter (Modern & Clean)</option>
                <option value="Poppins">Poppins (Bold & Friendly)</option>
                <option value="Arial">Arial (Standard)</option>
            </select>
        </div>
    </div>

    <div class="preview-area">
        <div class="canvas-wrapper">
            <canvas id="canvas" width="800" height="400"></canvas>
            <div class="hint" id="drag-hint">üñ±Ô∏è Drag images to adjust position</div>
        </div>
        
        <div class="actions">
            <button class="btn btn-secondary" onclick="generate()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="downloadImage()">üíæ Download WebP</button>
        </div>
    </div>
</div>

<script>
    // State
    const state = {
        template: 'blog',
        bgImg: null,
        leftImg: null,
        rightImg: null,
        offsets: { left: {x:0, y:0}, right: {x:0, y:0} },
        drag: { active: false, target: null, start: {x:0, y:0} }
    };

    // Elements
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Init Canvas
    canvas.width = 800;
    canvas.height = 400;

    // --- Event Listeners ---
    
    // Inputs: Auto-refresh on any change
    document.querySelectorAll('input, textarea, select').forEach(el => {
        el.addEventListener('input', generate);
    });

    // File Uploads
    setupFileUpload('bg-upload', (img) => { state.bgImg = img; generate(); });
    setupFileUpload('left-img', (img) => { state.leftImg = img; generate(); });
    setupFileUpload('right-img', (img) => { state.rightImg = img; generate(); });

    function setupFileUpload(id, callback) {
        const input = document.getElementById(id);
        const box = input.nextElementSibling;
        
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            handleFile(file, callback, box);
        });

        // Drag & Drop visual feedback
        input.addEventListener('dragover', () => box.classList.add('dragover'));
        input.addEventListener('dragleave', () => box.classList.remove('dragover'));
        input.addEventListener('drop', (e) => {
            box.classList.remove('dragover');
            // The input handles the file list automatically, but we intercept change
        });
    }

    function handleFile(file, callback, boxElement) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                callback(img);
                if(boxElement) boxElement.querySelector('.upload-text').innerText = "Image Loaded! ‚úÖ";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Template Switching
    window.switchTemplate = (type) => {
        state.template = type;
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.t-btn[data-template="${type}"]`).classList.add('active');
        
        document.getElementById('blog-controls').classList.toggle('hidden', type !== 'blog');
        document.getElementById('vs-controls').classList.toggle('hidden', type !== 'vs');
        
        document.getElementById('drag-hint').style.display = type === 'vs' ? 'block' : 'none';
        generate();
    };

    // --- Canvas Drawing Logic ---

    function generate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (state.template === 'blog') drawBlogHeader();
        else drawVSHeader();
    }

    function drawBlogHeader() {
        // Background
        if (state.bgImg) {
            drawCoverImage(state.bgImg);
        } else {
            const grad = ctx.createLinearGradient(0, 0, 800, 400);
            grad.addColorStop(0, '#1e293b');
            grad.addColorStop(1, '#334155');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0, 800, 400);
        }

        // Overlay
        const opacity = document.getElementById('overlay-opacity').value / 100;
        ctx.fillStyle = `rgba(0,0,0,${opacity})`;
        ctx.fillRect(0,0, 800, 400);

        // Text Config
        const font = document.getElementById('font-family').value;
        const scale = document.getElementById('font-scale').value / 100;
        const primaryCol = document.getElementById('color-primary').value;
        const accentCol = document.getElementById('color-accent').value;

        // Subtitle
        const subtitle = document.getElementById('blog-subtitle').value;
        ctx.font = `600 ${24 * scale}px ${font}`;
        ctx.fillStyle = primaryCol;
        ctx.textAlign = 'center';
        ctx.globalAlpha = 0.9;
        ctx.fillText(subtitle.toUpperCase(), 400, 100);
        ctx.globalAlpha = 1.0;

        // Main Title (Wrapping)
        const title = document.getElementById('blog-title').value;
        ctx.font = `800 ${52 * scale}px ${font}`;
        wrapText(title, 400, 180, 700, 65 * scale, primaryCol, accentCol);

        // URL
        drawUrl(primaryCol);
    }

    function drawVSHeader() {
        const font = document.getElementById('font-family').value;
        
        // Background
        ctx.fillStyle = '#f8fafc';
        ctx.fillRect(0,0, 800, 400);

        // Header Strip
        ctx.fillStyle = document.getElementById('vs-header-bg').value;
        ctx.fillRect(0,0, 800, 60);

        // Header Text
        ctx.font = `700 20px ${font}`;
        ctx.fillStyle = document.getElementById('vs-header-text').value;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(document.getElementById('vs-title').value, 25, 32);
        
        // Header URL
        ctx.textAlign = 'right';
        ctx.font = `600 16px ${font}`;
        ctx.globalAlpha = 0.9;
        ctx.fillText(document.getElementById('website-url').value, 775, 32);
        ctx.globalAlpha = 1.0;

        // --- Circles Layout ---
        const centerY = 200; // shifted down slightly
        const cx = 400;
        const r = 90; 
        const offset = 130;
        
        const leftX = cx - offset;
        const rightX = cx + offset;

        const leftCol = document.getElementById('vs-left-col').value;
        const rightCol = document.getElementById('vs-right-col').value;

        // Draw Left Product Circle
        drawProductCircle(leftX, centerY, r, state.leftImg, state.offsets.left, leftCol);
        // Draw Right Product Circle
        drawProductCircle(rightX, centerY, r, state.rightImg, state.offsets.right, rightCol);

        // VS Badge
        drawVSBadge(cx, centerY);

        // Labels & Descriptions
        const labelY = centerY + r + 35;
        
        // Left Label
        drawBadgeLabel(leftX, labelY, document.getElementById('left-name').value, leftCol, font);
        // Right Label
        drawBadgeLabel(rightX, labelY, document.getElementById('right-name').value, rightCol, font);

        // Descriptions
        const descY = labelY + 35;
        ctx.fillStyle = '#334155';
        ctx.font = `400 13px ${font}`;
        ctx.textAlign = 'center';
        
        wrapTextSimple(document.getElementById('left-desc').value, leftX, descY, 220, 18);
        wrapTextSimple(document.getElementById('right-desc').value, rightX, descY, 220, 18);
    }

    // --- Helpers ---

    function drawCoverImage(img) {
        const scale = Math.max(800/img.width, 400/img.height);
        const w = img.width * scale;
        const h = img.height * scale;
        ctx.drawImage(img, (800-w)/2, (400-h)/2, w, h);
    }

    function drawProductCircle(x, y, r, img, offset, color) {
        ctx.save();
        // Shadow
        ctx.shadowColor = 'rgba(0,0,0,0.15)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetY = 10;
        
        // Background circle
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI*2);
        ctx.fillStyle = 'white';
        ctx.fill();
        
        // Border
        ctx.shadowColor = 'transparent';
        ctx.lineWidth = 4;
        ctx.strokeStyle = color;
        ctx.stroke();

        // Clip & Image
        ctx.beginPath();
        ctx.arc(x, y, r-4, 0, Math.PI*2);
        ctx.clip();

        if(img) {
            // "Cover" fit logic for circle
            const scale = Math.max((r*2)/img.width, (r*2)/img.height);
            const w = img.width * scale;
            const h = img.height * scale;
            ctx.drawImage(img, x - w/2 + offset.x, y - h/2 + offset.y, w, h);
        } else {
            ctx.fillStyle = '#f1f5f9';
            ctx.fillRect(x-r, y-r, r*2, r*2);
            ctx.fillStyle = '#cbd5e1';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üì∑', x, y);
        }
        ctx.restore();
    }

    function drawVSBadge(x, y) {
        ctx.save();
        const grad = ctx.createLinearGradient(x-30, y-30, x+30, y+30);
        grad.addColorStop(0, '#ef4444');
        grad.addColorStop(1, '#b91c1c');
        
        ctx.beginPath();
        ctx.arc(x, y, 32, 0, Math.PI*2);
        ctx.fillStyle = grad;
        ctx.shadowColor = 'rgba(0,0,0,0.2)';
        ctx.shadowBlur = 10;
        ctx.fill();
        
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'white';
        ctx.stroke();

        ctx.fillStyle = 'white';
        ctx.font = '900 24px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = 'transparent';
        ctx.fillText('VS', x, y+2);
        ctx.restore();
    }

    function drawBadgeLabel(x, y, text, color, font) {
        ctx.save();
        ctx.font = `700 15px ${font}`;
        const width = Math.max(120, ctx.measureText(text).width + 30);
        const height = 36;

        // Pill shape background
        ctx.beginPath();
        ctx.roundRect(x - width/2, y, width, height, 18);
        ctx.fillStyle = color;
        ctx.shadowColor = 'rgba(0,0,0,0.1)';
        ctx.shadowBlur = 5;
        ctx.shadowOffsetY = 2;
        ctx.fill();

        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = 'transparent';
        ctx.fillText(text, x, y + height/2);
        ctx.restore();
    }

    function drawUrl(color) {
        if(state.template !== 'blog') return;
        const url = document.getElementById('website-url').value;
        const font = document.getElementById('font-family').value;
        ctx.font = `600 16px ${font}`;
        ctx.fillStyle = color;
        ctx.textAlign = 'right';
        ctx.fillText(url, 760, 370);
    }

    // Text Wrapper for Blog Title (With Accent Color support logic simplified)
    function wrapText(text, x, y, maxWidth, lineHeight, primaryCol, accentCol) {
        const words = text.split(' ');
        let line = '';
        let lines = [];

        for(let n = 0; n < words.length; n++) {
            let testLine = line + words[n] + ' ';
            let metrics = ctx.measureText(testLine);
            let testWidth = metrics.width;
            if (testWidth > maxWidth && n > 0) {
                lines.push(line);
                line = words[n] + ' ';
            } else {
                line = testLine;
            }
        }
        lines.push(line);

        let startY = y - ((lines.length-1)*lineHeight)/2;

        lines.forEach((l, i) => {
            // Simple logic: Highlight VIOX or every 3rd word for effect
            const lWords = l.trim().split(' ');
            let currentX = x - (ctx.measureText(l).width / 2); // Center alignment manual calculation
            
            ctx.textAlign = 'left';
            lWords.forEach((w, wi) => {
                const isAccent = w.toLowerCase().includes('viox') || (wi % 3 === 1 && lines.length < 3);
                ctx.fillStyle = isAccent ? accentCol : primaryCol;
                ctx.fillText(w, currentX, startY + (i*lineHeight));
                currentX += ctx.measureText(w + ' ').width;
            });
        });
    }

    function wrapTextSimple(text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        const lines = [];
        for(let n=0; n<words.length; n++) {
            let testLine = line + words[n] + ' ';
            if(ctx.measureText(testLine).width > maxWidth && n > 0) {
                lines.push(line);
                line = words[n] + ' ';
            } else {
                line = testLine;
            }
        }
        lines.push(line);
        
        // Limit to 3 lines
        lines.slice(0, 3).forEach((l, i) => {
            ctx.fillText(l.trim(), x, y + (i*lineHeight));
        });
    }

    // --- Drag Interaction (VS Mode) ---
    canvas.addEventListener('mousedown', (e) => {
        if(state.template !== 'vs') return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (800 / rect.width);
        const y = (e.clientY - rect.top) * (400 / rect.height);
        
        // Hit detection areas
        const cx = 400; const offset = 130;
        const areas = {
            left: { x: cx - offset, y: 200 },
            right: { x: cx + offset, y: 200 }
        };

        const distLeft = Math.sqrt((x-areas.left.x)**2 + (y-areas.left.y)**2);
        const distRight = Math.sqrt((x-areas.right.x)**2 + (y-areas.right.y)**2);

        if(distLeft < 85) { // 85 is slightly less than radius 90
            state.drag.active = true;
            state.drag.target = 'left';
            state.drag.start = { x: x - state.offsets.left.x, y: y - state.offsets.left.y };
            canvas.style.cursor = 'move';
        } else if(distRight < 85) {
            state.drag.active = true;
            state.drag.target = 'right';
            state.drag.start = { x: x - state.offsets.right.x, y: y - state.offsets.right.y };
            canvas.style.cursor = 'move';
        }
    });

    window.addEventListener('mousemove', (e) => {
        if(!state.drag.active) return;
        e.preventDefault();
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (800 / rect.width);
        const y = (e.clientY - rect.top) * (400 / rect.height);

        const target = state.drag.target;
        // Calculate new offset
        let newX = x - state.drag.start.x;
        let newY = y - state.drag.start.y;

        // Limit drag range
        const limit = 60;
        newX = Math.max(-limit, Math.min(limit, newX));
        newY = Math.max(-limit, Math.min(limit, newY));

        state.offsets[target] = { x: newX, y: newY };
        generate();
    });

    window.addEventListener('mouseup', () => {
        state.drag.active = false;
        canvas.style.cursor = 'default';
    });

    // --- Download Logic (Fixed Length Limit) ---
    function downloadImage() {
        // Determine filename
        let name = "";
        if(state.template === 'blog') name = document.getElementById('blog-title').value;
        else name = document.getElementById('vs-title').value;

        // Clean filename but keep full length
        let filename = name
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, '') // Remove special chars
            .replace(/\s+/g, '-') // Spaces to dashes
            .replace(/^-+|-+$/g, ''); // Trim dashes
        
        if(!filename) filename = "header-image";

        const link = document.createElement('a');
        link.download = `${filename}.webp`;
        link.href = canvas.toDataURL('image/webp', 0.9);
        link.click();
    }

    // Initial Draw
    generate();

</script>
</body>
</html>
